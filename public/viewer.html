<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ® í…Œì´ë¸”íƒ‘ ì‹œë®¬ë ˆì´í„° ì‹œì²­</title>
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }
        
        body { 
            background: #000; 
            overflow: hidden; 
            font-family: Arial, sans-serif;
        }
        
        #video-container { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100vw; 
            height: 100vh; 
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        #remoteVideo { 
            width: 100%; 
            height: 100%; 
            object-fit: contain;
            background: #000;
            
            /* í…Œì´ë¸”íƒ‘ìš© ë Œë”ë§ ìµœì í™” */
            transform: translateZ(0); /* í•˜ë“œì›¨ì–´ ê°€ì† */
            -webkit-transform: translateZ(0);
            will-change: transform; /* GPU ë Œë”ë§ íŒíŠ¸ */
            image-rendering: optimizeSpeed; /* ë¹ ë¥¸ ë Œë”ë§ */
            image-rendering: -webkit-optimize-contrast;
            image-rendering: optimize-contrast;
        }
        
        /* PIP ë²„íŠ¼ ìˆ¨ê¸°ê¸° */
        #remoteVideo::-webkit-media-controls-picture-in-picture-button {
            display: none !important;
        }
        
        #remoteVideo::-webkit-media-controls-pip-button {
            display: none !important;
        }
        
        /* Firefox PIP ë²„íŠ¼ ìˆ¨ê¸°ê¸° */
        #remoteVideo::-moz-media-controls-picture-in-picture {
            display: none !important;
        }
        
        /* ëª¨ë“  PIP ê´€ë ¨ ì»¨íŠ¸ë¡¤ ìˆ¨ê¸°ê¸° */
        video::-webkit-media-controls-picture-in-picture-button,
        video::-webkit-media-controls-pip-button {
            display: none !important;
        }
        
        #loading-overlay {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #fff;
            text-align: center;
            z-index: 10;
            background: rgba(0,0,0,0.8);
            padding: 20px;
            border-radius: 10px;
            font-size: 18px;
        }
        
        .spinner {
            border: 3px solid #333;
            border-top: 3px solid #fff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .hidden { 
            display: none !important; 
        }
    </style>
</head>
<body>
    <!-- ì „ì²´í™”ë©´ ë¹„ë””ì˜¤ ì»¨í…Œì´ë„ˆ -->
    <div id="video-container">
        <video id="remoteVideo" autoplay playsinline controls disablepictureinpicture></video>
    </div>
    
    <!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
    <div id="loading-overlay">
        <div class="spinner"></div>
        <div id="loading-text">ğŸ® í…Œì´ë¸”íƒ‘ ì‹œë®¬ë ˆì´í„° ì—°ê²° ì¤‘...</div>
        <div style="font-size: 14px; margin-top: 10px; opacity: 0.7;">í˜¸ìŠ¤íŠ¸ê°€ í™”ë©´ ê³µìœ ë¥¼ ì‹œì‘í–ˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”</div>
    </div>

    <script>
        var socket;
        var peerConnection;
        var reconnectAttempts = 0;
        var maxReconnectAttempts = 10;
        
        function updateLoadingText(text) {
            var loadingText = document.getElementById('loading-text');
            if (loadingText) loadingText.textContent = text;
        }
        
        function hideLoading() {
            var loadingOverlay = document.getElementById('loading-overlay');
            if (loadingOverlay) loadingOverlay.classList.add('hidden');
        }
        
        function showLoading(text) {
            var loadingOverlay = document.getElementById('loading-overlay');
            if (loadingOverlay) {
                loadingOverlay.classList.remove('hidden');
                updateLoadingText(text || 'ğŸ® í…Œì´ë¸”íƒ‘ ì‹œë®¬ë ˆì´í„° ì—°ê²° ì¤‘...');
            }
        }
        
        function startConnection() {
            showLoading('ğŸ”Œ ì„œë²„ ì—°ê²° ì¤‘...');
            
            if (socket) socket.disconnect();
            
            socket = io();
            
            socket.on('connect', function() {
                updateLoadingText('ğŸ“ ì‹œì²­ì ë“±ë¡ ì¤‘...');
                
                socket.emit('register-viewer');
                
                setTimeout(function() {
                    updateLoadingText('ğŸ“¡ í˜¸ìŠ¤íŠ¸ ëŒ€ê¸° ì¤‘...');
                    socket.emit('request-stream');
                }, 500);
            });
            
            socket.on('disconnect', function() {
                showLoading('âŒ ì„œë²„ ì—°ê²° ëŠê¹€ - ìë™ ì¬ì—°ê²° ì¤‘...');
                autoReconnect();
            });
            
            socket.on('connect_error', function(error) {
                showLoading('âŒ ì—°ê²° ì‹¤íŒ¨ - ìë™ ì¬ì‹œë„ ì¤‘...');
                autoReconnect();
            });
            
            setupWebRTCHandlers();
        }
        
        function autoReconnect() {
            if (reconnectAttempts >= maxReconnectAttempts) {
                showLoading('âŒ ì—°ê²° ì‹¤íŒ¨: í˜¸ìŠ¤íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                setTimeout(function() {
                    reconnectAttempts = 0;
                    startConnection();
                }, 30000);
                return;
            }
            
            reconnectAttempts++;
            showLoading('ğŸ”„ ìë™ ì¬ì—°ê²° ì¤‘... (' + reconnectAttempts + '/' + maxReconnectAttempts + ')');
            
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            
            clearVideo();
            
            var delay = Math.min(reconnectAttempts * 1000, 10000);
            setTimeout(function() {
                if (socket && socket.connected) {
                    socket.emit('register-viewer');
                    
                    setTimeout(function() {
                        socket.emit('request-stream');
                    }, 500);
                } else {
                    startConnection();
                }
            }, delay);
        }
        
        function setupWebRTCHandlers() {
            socket.on('offer', function(offer, hostId) {
                updateLoadingText('ğŸ”§ WebRTC ì—°ê²° ì„¤ì • ì¤‘...');
                reconnectAttempts = 0;
                handleOffer(offer, hostId);
            });
            
            socket.on('ice-candidate', function(candidate, hostId) {
                handleIceCandidate(candidate);
            });
            
            socket.on('host-disconnected', function() {
                showLoading('ğŸ“´ í˜¸ìŠ¤íŠ¸ê°€ ì—°ê²°ì„ ì¢…ë£Œí–ˆìŠµë‹ˆë‹¤ - ìë™ ì¬ì—°ê²° ì¤‘...');
                clearVideo();
                autoReconnect();
            });
            
            socket.on('host-stopped-sharing', function() {
                showLoading('â¹ï¸ í˜¸ìŠ¤íŠ¸ê°€ í™”ë©´ ê³µìœ ë¥¼ ì¤‘ë‹¨í–ˆìŠµë‹ˆë‹¤ - ìë™ ì¬ì—°ê²° ì¤‘...');
                clearVideo();
                autoReconnect();
            });
        }
        
        function handleOffer(offer, hostId) {
            try {
                if (peerConnection) peerConnection.close();
                
                // ì´ˆì €ì§€ì—° PeerConnection ì„¤ì •
                peerConnection = new RTCPeerConnection({
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' },
                        { urls: 'stun:stun2.l.google.com:19302' },
                        { 
                            urls: 'turn:openrelay.metered.ca:80',
                            username: 'openrelayproject',
                            credential: 'openrelayproject'
                        }
                    ],
                    iceCandidatePoolSize: 3,
                    bundlePolicy: 'max-bundle',
                    rtcpMuxPolicy: 'require',
                    encodedInsertableStreams: false
                });
                
                peerConnection.oniceconnectionstatechange = function() {
                    if (peerConnection.iceConnectionState === 'connected') {
                        updateLoadingText('âœ… ì—°ê²° ì™„ë£Œ! ë¹„ë””ì˜¤ ë¡œë”© ì¤‘...');
                    } else if (peerConnection.iceConnectionState === 'failed') {
                        showLoading('âŒ ì—°ê²° ì‹¤íŒ¨ - ìë™ ì¬ì‹œë„ ì¤‘...');
                        autoReconnect();
                    }
                };
                
                peerConnection.onconnectionstatechange = function() {
                    if (peerConnection.connectionState === 'connected') {
                        updateLoadingText('ğŸ¬ ë¹„ë””ì˜¤ ìŠ¤íŠ¸ë¦¼ ìˆ˜ì‹  ì¤‘...');
                    } else if (peerConnection.connectionState === 'failed') {
                        showLoading('âŒ ì—°ê²° ì‹¤íŒ¨ - ìë™ ì¬ì‹œë„ ì¤‘...');
                        autoReconnect();
                    }
                };
                
                peerConnection.onicecandidate = function(event) {
                    if (event.candidate) {
                        socket.emit('ice-candidate', event.candidate, socket.id);
                    }
                };
                
                peerConnection.ontrack = function(event) {
                    if (event.streams[0]) {
                        var video = document.getElementById('remoteVideo');
                        
                        video.srcObject = event.streams[0];
                        
                        // ì´ˆì €ì§€ì—° ë¹„ë””ì˜¤ ì„¤ì •
                        try {
                            video.disablePictureInPicture = true;
                            video.setAttribute('disablePictureInPicture', 'true');
                            video.preload = 'none';
                            video.setAttribute('webkit-playsinline', 'true');
                            video.setAttribute('playsinline', 'true');
                            video.style.imageRendering = 'optimizeSpeed';
                            video.style.transform = 'translateZ(0)';
                            video.style.backfaceVisibility = 'hidden';
                            video.setAttribute('muted', 'false');
                            
                            // ì¶”ê°€ ë”œë ˆì´ ìµœì†Œí™” ì„¤ì •
                            video.currentTime = 0;
                            video.defaultPlaybackRate = 1.0;
                            video.playbackRate = 1.0;
                        } catch (e) {
                            // ë¬´ì‹œ
                        }
                        
                        video.onloadeddata = function() {
                            if (video.videoWidth <= 2 || video.videoHeight <= 2) {
                                showLoading('âš ï¸ í˜¸ìŠ¤íŠ¸ê°€ í™”ë©´ ê³µìœ ë¥¼ ì‹œì‘í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤ - ìë™ ì¬ì‹œë„ ì¤‘...');
                                setTimeout(autoReconnect, 5000);
                            } else {
                                hideLoading();
                            }
                        };
                        
                        video.onerror = function(e) {
                            showLoading('âŒ ë¹„ë””ì˜¤ ì¬ìƒ ì˜¤ë¥˜ - ìë™ ì¬ì‹œë„ ì¤‘...');
                            autoReconnect();
                        };
                    }
                };
                
                // ì´ˆì €ì§€ì—° Answer ìƒì„±
                peerConnection.setRemoteDescription(new RTCSessionDescription(offer)).then(function() {
                    return peerConnection.createAnswer({
                        offerToReceiveVideo: true,
                        offerToReceiveAudio: true,
                        voiceActivityDetection: false,
                        iceRestart: false
                    });
                }).then(function(answer) {
                    return peerConnection.setLocalDescription(answer);
                }).then(function() {
                    socket.emit('answer', peerConnection.localDescription, socket.id);
                    updateLoadingText('ğŸ“¡ ICE ì—°ê²° ì‹œë„ ì¤‘...');
                }).catch(function(error) {
                    showLoading('âŒ ì—°ê²° ì„¤ì • ì‹¤íŒ¨ - ìë™ ì¬ì‹œë„ ì¤‘...');
                    autoReconnect();
                });
                
            } catch (e) {
                showLoading('âŒ WebRTC ì„¤ì • ì˜¤ë¥˜ - ìë™ ì¬ì‹œë„ ì¤‘...');
                autoReconnect();
            }
        }
        
        function handleIceCandidate(candidate) {
            if (peerConnection && peerConnection.remoteDescription) {
                try {
                    peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
                } catch (e) {
                    // ë¬´ì‹œ
                }
            }
        }
        
        function clearVideo() {
            var video = document.getElementById('remoteVideo');
            if (video) {
                video.srcObject = null;
                video.pause();
            }
        }
        
        // ì „ì—­ ì˜¤ë¥˜ ì²˜ë¦¬
        window.onerror = function(message, source, line, col, error) {
            showLoading('âŒ ì˜¤ë¥˜ ë°œìƒ - ìë™ ì¬ì‹œë„ ì¤‘...');
            autoReconnect();
        };
        
        // ìë™ ì‹œì‘
        setTimeout(startConnection, 1000);
    </script>
    
    <script src="/socket.io/socket.io.js"></script>
</body>
</html> 